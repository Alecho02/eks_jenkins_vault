// Jenkinsfile

podTemplate(
    label: 'ci-agent',
    namespace: 'jenkins',
    serviceAccount: 'jenkins',
    containers: [
        containerTemplate(
            name: 'maven',
            image: 'maven:3.9-eclipse-temurin-17',
            ttyEnabled: true,
            command: 'cat',
            workingDir: '/home/jenkins/agent'
        )
    ]
) {
    node('ci-agent') {

        def APP_DIR = 'app/microservice'

        stage('Checkout') {
            checkout scm
        }

        stage('Build & Test') {
            container('maven') {
                dir(APP_DIR) {
                    sh 'mvn -B clean test'
                }
            }
        }

        stage('Package') {
            container('maven') {
                dir(APP_DIR) {
                    sh 'mvn -B package -DskipTests'
                }
            }
        }

        // Aquí después añadimos:
        // - Build & push Docker image a ECR
        // - kubectl apply al namespace de dev
    }
}
