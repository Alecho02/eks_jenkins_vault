// Jenkinsfile - Jenkins en EKS, build+push a ECR y deploy a eks-development

podTemplate(
    label: 'ci-agent',
    namespace: 'jenkins',
    serviceAccount: 'jenkins',
    containers: [
        // 1) Build Java (Maven)
        containerTemplate(
            name: 'maven',
            image: 'maven:3.9-eclipse-temurin-17',
            ttyEnabled: true,
            command: 'cat',
            workingDir: '/home/jenkins/agent'
        ),

        // 2) AWS CLI (para ECR login y eks update-kubeconfig)
        containerTemplate(
            name: 'aws',
            image: 'amazon/aws-cli:2.15.36',
            ttyEnabled: true,
            command: 'sh',
            args: '-c cat',
            workingDir: '/home/jenkins/agent'
        ),

        // 3) Docker CLI (habla con el daemon dind)
        containerTemplate(
            name: 'docker',
            image: 'docker:27',
            ttyEnabled: true,
            command: 'sh',
            args: '-c cat',
            workingDir: '/home/jenkins/agent',
            envVars: [
                envVar(key: 'DOCKER_HOST', value: 'tcp://localhost:2375'),
                envVar(key: 'DOCKER_TLS_CERTDIR', value: '')
            ]
        ),

        // 4) Docker-in-Docker (el daemon)
        containerTemplate(
            name: 'dind',
            image: 'docker:27-dind',
            ttyEnabled: true,
            privileged: true,
            command: 'dockerd-entrypoint.sh',
            args: '--host=tcp://0.0.0.0:2375',
            workingDir: '/home/jenkins/agent'
        ),

        // 5) kubectl para desplegar al cluster de dev (imagen con /bin/sh)
        containerTemplate(
            name: 'kubectl',
            image: 'bitnami/kubectl:latest',   // ðŸ‘ˆ imagen con shell
            ttyEnabled: true,
            command: 'sh',
            args: '-c cat',
            workingDir: '/home/jenkins/agent'
        )
    ],
    // Donde Docker guardarÃ¡ sus capas (solo dentro del pod del build)
    volumes: [
        emptyDirVolume(mountPath: '/var/lib/docker', memory: false)
    ]
) {

    node('ci-agent') {

        // === Constantes de tu entorno ===
        def APP_DIR          = 'prueba_v1c3nt3/app/microservice'
        def AWS_REGION       = 'eu-west-1'
        def ECR_REGISTRY     = '385205418910.dkr.ecr.eu-west-1.amazonaws.com'
        def ECR_REPO         = "${ECR_REGISTRY}/microservice-devops"
        def EKS_CLUSTER      = 'eks-development'
        def K8S_MANIFEST     = 'k8s/development/deployment.yaml'
        def IMAGE_TAG        = "build-${env.BUILD_NUMBER}"
        def FULL_IMAGE       = "${ECR_REPO}:${IMAGE_TAG}"
        def KUBECONFIG_FILE  = "${env.WORKSPACE}/kubeconfig"
        def ECR_PASSWORD_FILE = "${env.WORKSPACE}/ecr_password.txt"

        stage('Checkout') {
            checkout scm
        }

        stage('Build & Test (Maven)') {
            container('maven') {
                dir(APP_DIR) {
                    sh 'mvn -B clean test'
                }
            }
        }

        stage('Package (JAR)') {
            container('maven') {
                dir(APP_DIR) {
                    sh 'mvn -B package -DskipTests'
                }
            }
        }

        stage('Login ECR (AWS CLI)') {
            container('aws') {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-devops',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    sh """
                        set -e
                        aws --version
                        aws ecr get-login-password --region ${AWS_REGION} > "${ECR_PASSWORD_FILE}"
                    """
                }
            }
        }

        stage('Build & Push Docker image a ECR') {
            container('docker') {
                sh """
                    set -e
                    echo "Autenticando contra ECR..."
                    PASS=\$(cat "${ECR_PASSWORD_FILE}")
                    echo "\$PASS" | docker login \\
                      --username AWS \\
                      --password-stdin ${ECR_REGISTRY}

                    echo "Build de la imagen: ${FULL_IMAGE}"
                    docker build \\
                      -t ${FULL_IMAGE} \\
                      -f ${APP_DIR}/Dockerfile \\
                      ${APP_DIR}

                    echo "Push de la imagen a ECR..."
                    docker push ${FULL_IMAGE}
                """
            }
        }

        stage('Preparar kubeconfig para eks-development') {
            container('aws') {
                withCredentials([[
                    $class: 'AmazonWebServicesCredentialsBinding',
                    credentialsId: 'aws-devops',
                    accessKeyVariable: 'AWS_ACCESS_KEY_ID',
                    secretKeyVariable: 'AWS_SECRET_ACCESS_KEY'
                ]]) {
                    sh """
                        set -e
                        export AWS_REGION=${AWS_REGION}
                        aws eks update-kubeconfig \\
                          --name ${EKS_CLUSTER} \\
                          --region ${AWS_REGION} \\
                          --kubeconfig "${KUBECONFIG_FILE}"
                    """
                }
            }
        }

        stage('Deploy a EKS (dev)') {
            container('kubectl') {
                sh """
                    set -e
                    echo "Usando kubeconfig: ${KUBECONFIG_FILE}"
                    kubectl --kubeconfig="${KUBECONFIG_FILE}" get nodes

                    echo "Actualizando deployment en namespace microservice..."
                    kubectl --kubeconfig="${KUBECONFIG_FILE}" apply -f ${K8S_MANIFEST}

                    echo "Estado de pods"
                    kubectl --kubeconfig="${KUBECONFIG_FILE}" -n microservice get pods
                """
            }
        }
    }
}
